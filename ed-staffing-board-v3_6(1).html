<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ED Staffing Board — v3.6</title>
<style>
  :root{
    --bg:#0e1117; --panel:#141925; --text:#f2f5fb; --muted:#aeb9cf; --accent:#4aa3ff;
    --ok:#28c990; --warn:#f5a524; --danger:#ef5b5b; --line:#273044; --slot:#111726;
    --gap:18px; --radius:14px; --cell: clamp(54px, 4.8vh, 70px);
    --f: clamp(16px,1.05vw,19px); --f-lg: clamp(19px,1.5vw,24px); --f-xl: clamp(26px,2.4vw,34px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  .wrap{max-width:1920px;margin:0 auto;padding:var(--gap)}
  header{display:grid;grid-template-columns:1fr auto auto;gap:var(--gap);align-items:center;margin-bottom:var(--gap)}
  .title{font-size:var(--f-xl);font-weight:800;letter-spacing:.2px}
  .subtitle{color:var(--muted);font-size:var(--f)}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn,.input,.select,textarea{border-radius:12px;border:1px solid var(--line);background:#101624;color:var(--text);padding:10px 12px;font-size:var(--f);}
  .btn{height:44px;cursor:pointer;user-select:none}
  .btn.accent{background:var(--accent);border-color:#2b84e6;color:#06121f;font-weight:700}
  .btn.ok{background:var(--ok);border-color:#1b9a70;color:#04150f;font-weight:700}
  .btn.warn{background:var(--warn);border-color:#c88415;color:#1b1203;font-weight:700}
  .tabs{display:flex;gap:8px;margin-bottom:var(--gap)}
  .tab{padding:10px 14px;border-radius:10px;border:1px solid var(--line);cursor:pointer;background:#0f1522}
  .tab.active{background:#1a2132;box-shadow:inset 0 0 0 1px #2b3650}
  .grid{display:grid;grid-template-columns: 1.5fr 2fr 1fr;gap:var(--gap)}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:var(--gap);box-shadow:0 1px 0 rgba(0,0,0,.2)}
  .section{margin-bottom:var(--gap)}
  .section h3{margin:0 0 8px 0;font-size:var(--f-lg)}
  .legend{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:var(--f)}
  .dot{width:10px;height:10px;border-radius:50%}
  .row{display:flex;gap:var(--gap);align-items:center;margin-bottom:10px;flex-wrap:wrap}
  .slot{flex:1;min-height:var(--cell);display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;background:var(--slot);border:1px solid var(--line)}
  .pill{font-size:.9em;color:var(--muted);background:#0d1422;border:1px solid var(--line);padding:4px 8px;border-radius:999px;white-space:nowrap}
  .tile{display:flex;gap:10px;align-items:center;justify-content:space-between;width:100%}
  .who{display:flex;gap:10px;align-items:center}
  .name{font-size:var(--f-lg);font-weight:800}
  .rf{font-size:.95em;color:var(--muted)}
  .badges{display:flex;gap:6px;align-items:center}
  .badge{font-size:.78em;border-radius:6px;border:1px solid var(--line);padding:3px 6px;color:#cfd3e4}
  .badge.j{background:#0e2a1d;color:#7fe0b4;border-color:#204b36}
  .badge.t{background:#0c2031;color:#8ecbff;border-color:#254a6d}
  .badge.f{background:#2a1b15;color:#ffc6a1;border-color:#5b3929}
  .badge.o{background:#26262b;color:#c7c7cf;border-color:#3a3a44}
  .status{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .status .chip{font-size:.78em;border-radius:999px;border:1px solid var(--line);padding:3px 8px;color:#cbd3e4}
  .chip.break{background:#33240f;color:#ffd9a1}
  .chip.cover{background:#102635;color:#9ad7ff}
  .chip.dto{background:#3a1212;color:#ffb1b1}
  .dim{opacity:.5}
  .eta{font-variant-numeric:tabular-nums}
  .students{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .student{font-size:.82em;background:#131922;border:1px dashed #2e3746;color:#cfd7ea;border-radius:8px;padding:3px 6px;cursor:grab}
  /* TV Landscape zones */
  #zoneContainer{ display:grid; grid-template-columns: repeat(4, minmax(260px, 1fr)); gap: 12px; }
  @media (max-width:1600px){ #zoneContainer{ grid-template-columns: repeat(3, minmax(260px, 1fr)); } }
  @media (max-width:1200px){ #zoneContainer{ grid-template-columns: repeat(2, minmax(260px, 1fr)); } }
  .zone{display:flex;flex-direction:column;gap:10px; min-height: calc(var(--cell) + 24px);}
  .zone .zone-title{display:flex;justify-content:space-between;align-items:center;font-weight:800;margin-bottom:2px}
  .zone .zone-title .mini-btns{display:flex;gap:6px}
  .zone .drop{min-height:calc(var(--cell) + 8px);padding:8px;border:1px dashed #334057;border-radius:10px; background:#0f1522}
  .subtle{color:var(--muted);font-size:1em}
  .side{display:flex;flex-direction:column;gap:var(--gap)}
  .side .list{display:flex;flex-direction:column;gap:8px}
  .mini{display:flex;flex-direction:column;gap:4px;background:#151925;border:1px solid var(--line);padding:10px;border-radius:10px;cursor:pointer}
  .mini .title{font-size:var(--f);font-weight:800}
  .mini .meta{color:var(--muted);font-size:.95em}
  .footer{margin-top:var(--gap);display:flex;justify-content:space-between;align-items:center;color:var(--muted)}
  .clock{font-size:var(--f-lg);font-variant-numeric:tabular-nums}
  .columns{display:grid;grid-template-columns:1.2fr 1.8fr 1fr;gap:var(--gap)}
  .listbox{min-height:260px;background:#101623;border:1px solid var(--line);border-radius:10px;padding:10px}
  .listbox .item{padding:10px;border-radius:8px;border:1px solid #2d3645;background:#0f131b;margin-bottom:8px;cursor:grab}
  /* Scroll-locked roster */
  #rosterWrap{max-height:60vh; overflow:auto; overscroll-behavior: contain; padding-right:4px;}
  .kicker{font-size:.92em;color:var(--muted)}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--line);padding:10px 6px;text-align:left;font-size:0.98em}
  .table th{color:#cdd6eb;font-weight:800}
  .pill2{display:inline-block;padding:2px 6px;border-radius:6px;border:1px solid var(--line);background:#0f1420}
  @media print{ body{background:#fff;color:#000} header,.tabs,.side .mini:nth-child(3),.btn{display:none !important} .panel{background:#fff;border-color:#999} .slot{background:#fff;border-color:#bbb} .wrap{max-width:100%;padding:8px} }
  @media (max-width:1200px){ .grid{grid-template-columns:1fr} .columns{grid-template-columns:1fr} }
  body.dimmed .wrap{opacity:0.95;filter:saturate(.9) brightness(.95)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#1a2533;color:#e9f1ff;border:1px solid #2c3a4d;padding:10px 14px;border-radius:10px;display:none;z-index:9999}
  #importLog{font-size:0.95em;white-space:pre-wrap;background:#0f1522;border:1px solid var(--line);padding:10px;border-radius:10px;min-height:44px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <div class="title">ED Staffing Board</div>
      <div class="subtitle" id="dateLabel"></div>
    </div>
    <div class="toolbar">
      <button class="btn" id="prevDay">◀︎ Prev</button>
      <input class="input" type="date" id="datePicker">
      <button class="btn" id="nextDay">Next ▶︎</button>
      <select class="select" id="shiftSel">
        <option value="day">Day (07–19)</option>
        <option value="night">Night (19–07)</option>
      </select>
    </div>
    <div class="toolbar">
      <span id="lockState" class="subtitle">Locked</span>
      <button class="btn accent" id="unlockBtn">Unlock</button>
      <button class="btn" id="undoBtn">Undo</button>
      <button class="btn" id="redoBtn">Redo</button>
      <button class="btn ok" id="printBtn">Print</button>
      <button class="btn warn" id="startNewShiftBtn">Start New Shift</button>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-tab="main">Main</div>
    <div class="tab" data-tab="pending">Pending</div>
    <div class="tab" data-tab="settings">Settings</div>
    <div class="tab" data-tab="history">History</div>
  </div>

  <div id="tab-main">
    <div class="panel" style="margin-bottom:var(--gap)">
      <div class="legend">
        <span class="dot" style="background:var(--ok)"></span> Charge
        <span class="dot" style="background:var(--accent)"></span> Triage
        <span class="badge j">J</span> Jewish ER
        <span class="badge t">T</span> Travel
        <span class="badge f">F</span> Float
        <span class="badge o">O</span> Other
        <span class="subtle">Incoming dim until ETA; off‑going remain 40 min.</span>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div class="section">
          <h3>Leadership</h3>
          <div class="row">
            <div class="slot" data-role="charge"></div>
            <div class="slot" data-role="triage"></div>
          </div>
        </div>

        <div class="section">
          <h3>Assignments (TV Landscape)</h3>
          <div id="zoneContainer"></div>
        </div>

        <div class="section">
          <h3>Comments</h3>
          <textarea id="comments" class="input" style="width:100%;height:90px" placeholder="Notes that carry over until cleared…"></textarea>
        </div>
      </div>

      <div class="panel">
        <div class="section">
          <h3>Physicians (read-only)</h3>
          <div id="physList" class="list"></div>
          <div class="kicker">Source: iCal (daily). Set URL in Settings; or paste ICS if CORS blocks.</div>
        </div>

        <div class="section">
          <h3>Support Staff</h3>
          <div class="row">
            <div class="slot"><span class="pill">Techs</span><input id="techs" class="input" placeholder="Comma-separated…"></div>
          </div>
          <div class="row">
            <div class="slot"><span class="pill">Volunteers</span><input id="vols" class="input" placeholder="Comma-separated…"></div>
          </div>
          <div class="row">
            <div class="slot"><span class="pill">Sitters</span><input id="sitters" class="input" placeholder="Comma-separated…"></div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="panel mini">
          <div class="title">Incoming (click to toggle arrived)</div>
          <div id="incomingList" class="list"></div>
        </div>
        <div class="panel mini">
          <div class="title">Off-going (kept 40 min)</div>
          <div id="offgoingList" class="list"></div>
        </div>
        <div class="panel mini">
          <div class="title">Clock</div>
          <div class="clock" id="clock">--:--</div>
          <div class="meta">Auto prompts at 07:00 / 19:00.</div>
        </div>
      </div>
    </div>

    <div class="footer">
      <div class="subtle">Local, browser-only. PIN to edit. Default PIN: 4911</div>
      <div class="subtle">v3.6</div>
    </div>
  </div>

  <div id="tab-pending" style="display:none">
    <div class="columns">
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3>Roster (Next Shift)</h3>
          <div>
            <input id="rosterSearch" class="input" placeholder="Search name / ID / RF" style="width:240px">
            <select id="rosterSort" class="select">
              <option value="name">Name (A–Z)</option>
              <option value="class">Class → Name</option>
              <option value="id">ID (ascending)</option>
            </select>
          </div>
        </div>
        <div class="kicker">Drag nurses from here into slots.</div>
        <div id="rosterWrap"><!-- scroll-locked -->
          <div id="pendingRoster" class="listbox"></div>
        </div>
        <div class="kicker">Select a nurse to view last 5 roles below.</div>
        <div id="historyPane" class="panel" style="margin-top:12px">
          <div class="subtle">Select a nurse…</div>
        </div>
      </div>

      <div class="panel">
        <h3>Pending Assignments</h3>
        <div class="section">
          <div class="row">
            <div class="slot" data-pending="charge"></div>
            <div class="slot" data-pending="triage"></div>
          </div>
        </div>
        <div class="section">
          <div id="pendingZones"></div>
        </div>
        <div class="row">
          <button class="btn" id="saveDraft">Save Draft</button>
          <button class="btn" id="previewDraft">Preview</button>
          <button class="btn ok" id="startNext">Start Next Shift</button>
          <button class="btn warn" id="resetDraft">Reset Draft</button>
        </div>
      </div>

      <div class="panel">
        <h3>Incoming (Next Shift)</h3>
        <div class="listbox" id="pendingIncoming"></div>
        <div class="kicker">Click an item to edit ETA.</div>
      </div>
    </div>
  </div>

  <div id="tab-settings" style="display:none">
    <div class="columns">
      <div class="panel">
        <h3>Nurses</h3>
        <div class="kicker">Add/Edit nurses (double‑click a row to edit, including Employee ID).</div>
        <div id="nurseList" class="listbox"></div>
        <div class="row">
          <input id="nId" class="input" placeholder="Employee ID (exact)">
          <input id="nName" class="input" placeholder="Name (e.g., Alice Smith, RN)">
          <input id="nRF" class="input" placeholder="RF# / extension">
        </div>
        <div class="row">
          <select id="nClass" class="select">
            <option value="jewish">Jewish ER</option>
            <option value="travel">Travel</option>
            <option value="float">Float</option>
            <option value="other">Other</option>
          </select>
          <button class="btn ok" id="addNurse">Add Nurse</button>
        </div>
      </div>

      <div class="panel">
        <h3>Zones / Bed Groups</h3>
        <div id="zoneList" class="listbox"></div>
        <div class="row">
          <input id="zName" class="input" placeholder="e.g., Beds 1–5">
          <button class="btn ok" id="addZone">Add Zone</button>
        </div>

        <h3 style="margin-top:16px">Shifts</h3>
        <div class="row">
          <input id="dayAnchor" class="input" value="07:00" style="width:130px">
          <input id="nightAnchor" class="input" value="19:00" style="width:130px">
          <button class="btn" id="saveAnchors">Save</button>
        </div>

        <h3 style="margin-top:16px">PIN & Auto‑relock</h3>
        <div class="row">
          <input id="pinInput" class="input" placeholder="Set/Change PIN (4–6 digits)" style="width:240px">
          <button class="btn ok" id="savePin">Save PIN</button>
          <input id="relockMin" class="input" placeholder="Auto‑relock minutes (default 3)" style="width:240px">
          <button class="btn" id="saveRelock">Save</button>
        </div>
        <div class="kicker">Default PIN: 4911 (stored locally on this workstation)</div>

        <h3 style="margin-top:16px">Display / Power</h3>
        <div class="row">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="jigglerToggle">
            Keep screen awake (“mouse jiggler”, 30s)
          </label>
          <span class="kicker">Uses Screen Wake Lock when available; otherwise a tiny scroll nudge.</span>
        </div>
      </div>

      <div class="panel">
        <h3>Physician iCal</h3>
        <div class="kicker">Paste ICS text or set URL (daily). If CORS blocks direct fetch, paste ICS manually.</div>
        <div class="row">
          <input id="icsUrl" class="input" placeholder="https://… iCal URL">
          <button class="btn" id="saveIcsUrl">Save URL</button>
          <button class="btn" id="fetchIcsNow">Fetch Today</button>
        </div>
        <textarea id="icsText" class="input" style="width:100%;height:160px" placeholder="Paste raw .ics file text here…"></textarea>
        <div class="row">
          <button class="btn" id="parseIcs">Parse Pasted ICS</button>
        </div>

        <h3 style="margin-top:16px">Data</h3>
        <div class="row">
          <button class="btn" id="exportAll">Export JSON</button>
          <button class="btn" id="exportCSV">Export CSV (archives)</button>
          <label class="btn" for="importFile">Import JSON (smart)</label>
          <input type="file" id="importFile" accept="application/json" style="display:none">
          <label class="btn" for="importStaffFile">Import Staff (merge)</label>
          <input type="file" id="importStaffFile" accept="application/json" style="display:none">
          <button class="btn warn" id="clearAll">Clear All</button>
        </div>
        <div class="kicker">Tip: both import buttons can accept either a full export or a staff-only file.</div>
        <div style="margin-top:8px">
          <div class="kicker">Import Log</div>
          <div id="importLog"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-history" style="display:none">
    <div class="panel">
      <h3>Shift Archives</h3>
      <div class="row">
        <input id="histFilterName" class="input" placeholder="Filter by nurse name/id">
        <input id="histFrom" class="input" type="date">
        <input id="histTo" class="input" type="date">
        <button class="btn" id="histApply">Apply</button>
        <button class="btn" id="histClear">Clear</button>
      </div>
      <table class="table" id="histTable">
        <thead><tr><th>Date</th><th>Shift</th><th>Role</th><th>Nurse</th><th>DTO</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* Basic helpers & DB */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const todayISO = () => new Date().toISOString().slice(0,10);
const pad2 = n=> String(n).padStart(2,'0');
const parseHM = s=>{ const [h,m]=s.split(':').map(Number); return h*60+m; };
const minutesSinceMidnight = ()=>{ const d=new Date(); return d.getHours()*60+d.getMinutes(); };
function humanTime(hhmm){ const [h,m] = hhmm.split(':').map(Number); const ampm = h>=12?'PM':'AM'; const hh = ((h%12)||12); return `${hh}:${pad2(m)} ${ampm}`;}
const toast = (msg)=>{ const t=$('#toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 2200); };
function logImport(text){ const el=$('#importLog'); el.textContent = (el.textContent?el.textContent+'\\n':'')+text; }

const DB = (()=> {
  const DB_NAME = 'edb-v28';
  const STORE   = 'kv';
  let dbp;
  function getDB(){ if (dbp) return dbp; dbp = new Promise((resolve, reject)=>{ const req = indexedDB.open(DB_NAME, 1); req.onupgradeneeded = e => e.target.result.createObjectStore(STORE); req.onsuccess = e => resolve(e.target.result); req.onerror = e => reject(e.target.error); }); return dbp; }
  async function get(key){ const db = await getDB(); return new Promise((res, rej)=>{ const tx = db.transaction(STORE, 'readonly'); const os = tx.objectStore(STORE); const r = os.get(key); r.onsuccess = ()=> res(r.result); r.onerror = ()=> rej(r.error); }); }
  async function set(key, val){ const db = await getDB(); return new Promise((res, rej)=>{ const tx = db.transaction(STORE, 'readwrite'); const os = tx.objectStore(STORE); const r = os.put(val, key); r.onsuccess = ()=> res(true); r.onerror = ()=> rej(r.error); }); }
  async function del(key){ const db = await getDB(); return new Promise((res, rej)=>{ const tx = db.transaction(STORE, 'readwrite'); const os = tx.objectStore(STORE); const r = os.delete(key); r.onsuccess = ()=> res(true); r.onerror = e => rej(e.target.error); }); }
  async function keys(){ const db = await getDB(); return new Promise((res, rej)=>{ const ks = []; const tx = db.transaction(STORE, 'readonly'); const os = tx.objectStore(STORE); const c = os.openCursor(); c.onsuccess = e => { const cur = e.target.result; if (cur){ ks.push(cur.key); cur.continue(); } else res(ks); }; c.onerror = e => rej(e.target.error); }); }
  return {get,set,del,keys};
})();

/* Keys & state */
const KS = { CONFIG:'config', STAFF:'staff', HISTORY:'history', ACTIVE:(d,sh)=>`active:${d}:${sh}`, PENDING:(d,sh)=>`pending:${d}:${sh}`, ARCHIVE:'archives', PHYS:(d)=>`phys:${d}` };
let STATE = { date: todayISO(), shift:'day', locked:true, anchors:{day:'07:00', night:'19:00'}, zones:['Beds 1–5','Beds 6–10','Fast Track','Resus'], staff:[], pin:'4911', relockMin:3, icsUrl:'', jiggler:false };

/* Undo/Redo */
const UNDO = {stack:[], redo:[]}; async function pushUndo(){ const key = KS.ACTIVE(STATE.date, STATE.shift); const active = await DB.get(key); UNDO.stack.push({key, data: JSON.parse(JSON.stringify(active))}); UNDO.redo=[]; updateUndoUI(); }
async function doUndo(){ if (!UNDO.stack.length) return; const entry = UNDO.stack.pop(); const current = await DB.get(entry.key); UNDO.redo.push({key:entry.key, data: current}); await DB.set(entry.key, entry.data); renderAll(); updateUndoUI(); }
async function doRedo(){ if (!UNDO.redo.length) return; const entry = UNDO.redo.pop(); const current = await DB.get(entry.key); UNDO.stack.push({key:entry.key, data: current}); await DB.set(entry.key, entry.data); renderAll(); updateUndoUI(); }
function updateUndoUI(){ $('#undoBtn').disabled = !UNDO.stack.length; $('#redoBtn').disabled = !UNDO.redo.length; }

/* Boot */
let relockTimer=null, wakeLock=null, jigTimer=null;
window.addEventListener('error', e => { const t=document.getElementById('toast'); t.textContent = 'Error: ' + (e.message||e.error||''); t.style.display='block'; setTimeout(()=>t.style.display='none', 4000); });
(function init(){ (async()=>{ const cfg = await DB.get(KS.CONFIG); if (cfg){ Object.assign(STATE, cfg); if (!('pin' in cfg) && cfg.pinHash){ STATE.pin='4911'; } } const staff = await DB.get(KS.STAFF); if (staff) STATE.staff = staff; $("#datePicker").value=STATE.date; $("#shiftSel").value=STATE.shift; $("#dateLabel").textContent = new Date(STATE.date+"T00:00").toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric',year:'numeric'}); tickClock(); setInterval(tickClock,1000); bindNav(); bindTabs(); bindMain(); bindPending(); bindSettings(); bindHistory(); renderAll(); setInterval(checkAnchors, 20*1000); updateUndoUI(); setupAntiBurn(); if (STATE.icsUrl) tryFetchIcsForToday(); updateJiggler(); })(); })();

/* Anti-burn & relock */
function setupAntiBurn(){ let t; const reset=()=>{ document.body.classList.remove('dimmed'); clearTimeout(t); t=setTimeout(()=>document.body.classList.add('dimmed'), 8*60*1000); resetRelock(); }; ['mousemove','keydown','click','scroll','touchstart'].forEach(ev=> window.addEventListener(ev, reset, {passive:true})); reset(); }
function resetRelock(){ if (relockTimer) clearTimeout(relockTimer); if (!STATE.locked && STATE.relockMin && STATE.relockMin>0){ relockTimer = setTimeout(()=>{ STATE.locked=true; $("#lockState").textContent="Locked"; renderAll(); }, STATE.relockMin*60*1000); }}

/* Nav */
function bindNav(){ $("#prevDay").addEventListener('click', ()=> changeDateBy(-1)); $("#nextDay").addEventListener('click', ()=> changeDateBy(1)); $("#datePicker").addEventListener('change', ()=> { STATE.date = $("#datePicker").value; saveConfig(); renderAll(); }); $("#shiftSel").addEventListener('change', ()=> { STATE.shift = $("#shiftSel").value; saveConfig(); renderAll(); }); $("#printBtn").addEventListener('click', ()=> window.print()); $("#startNewShiftBtn").addEventListener('click', async ()=>{ if (STATE.locked){ alert("Unlock first (PIN)."); return; } if (!confirm("Start a NEW blank shift for this date/shift? (Archives current)")) return; const active = await loadActive() || freshShift(); await pushArchive({...active, archivedAt: new Date().toISOString(), reason:'manual'}); await logRolesFromObject(active); await saveActive(freshShift()); toast("New blank shift started"); renderAll(); }); $("#unlockBtn").addEventListener('click', async ()=>{ const pin = prompt("Enter PIN to unlock:"); if (!pin){ return; } if (pin === String(STATE.pin)){ STATE.locked=false; $("#lockState").textContent="Unlocked"; resetRelock(); toast("Unlocked"); } else alert("Wrong PIN"); renderAll(); }); $("#undoBtn").addEventListener('click', doUndo); $("#redoBtn").addEventListener('click', doRedo); }
function changeDateBy(n){ const d = new Date(STATE.date+"T00:00"); d.setDate(d.getDate()+n); STATE.date = d.toISOString().slice(0,10); $("#datePicker").value = STATE.date; $("#dateLabel").textContent = d.toLocaleDateString(undefined,{weekday:'long',month:'short',day:'numeric',year:'numeric'}); renderAll(); }

/* Tabs */
function bindTabs(){ $$(".tab").forEach(t=>{ t.addEventListener('click', ()=>{ $$(".tab").forEach(x=>x.classList.remove('active')); t.classList.add('active'); const tab = t.dataset.tab; $("#tab-main").style.display = tab==='main'?'block':'none'; $("#tab-pending").style.display = tab==='pending'?'block':'none'; $("#tab-settings").style.display = tab==='settings'?'block':'none'; $("#tab-history").style.display = tab==='history'?'block':'none'; }); }); }
function bindMain(){}
function bindPending(){}

/* Persist */
async function saveConfig(){ await DB.set(KS.CONFIG, { date: STATE.date, shift: STATE.shift, anchors: STATE.anchors, zones: STATE.zones, staff: STATE.staff, pin: STATE.pin, relockMin: STATE.relockMin, icsUrl: STATE.icsUrl, jiggler: STATE.jiggler }); }
async function loadActive(){ return await DB.get(KS.ACTIVE(STATE.date, STATE.shift)) || null; }
async function saveActive(obj){ return await DB.set(KS.ACTIVE(STATE.date, STATE.shift), obj); }
async function loadPending(){ const nextShift = STATE.shift==='day'?'night':'day'; return await DB.get(KS.PENDING(STATE.date, nextShift)) || null; }
async function savePending(obj){ const nextShift = STATE.shift==='day'?'night':'day'; return await DB.set(KS.PENDING(STATE.date, nextShift), obj); }
async function pushArchive(entry){ const arch = await DB.get(KS.ARCHIVE) || []; arch.push(entry); await DB.set(KS.ARCHIVE, arch); }
async function getHistory(){ return await DB.get(KS.HISTORY) || {}; }
async function setHistory(h){ return await DB.set(KS.HISTORY, h); }

/* Render */
async function renderAll(){ $("#lockState").textContent = STATE.locked ? "Locked" : "Unlocked"; await renderMain(); await renderPending(); renderSettingsLists(); await renderHistory(); }

function nurseBadge(cls){ const map = {jewish:'j', travel:'t', float:'f', other:'o'}; const code = map[cls] || 'o'; const label = {j:'J', t:'T', f:'F', o:'O'}[code]; return `<span class="badge ${code}" title="${cls}">${label}</span>`; }
function nurseTile(nurse, opts={}){ if (!nurse) return `<div class="subtle">—</div>`; const rf = nurse.rf ? `<span class="rf">RF ${nurse.rf}</span>` : ''; const badges = `<div class="badges">${nurseBadge(nurse.class||'other')}</div>`; const statusChips = (opts.status||[]).map(s=>{ if (s==='break') return `<span class="chip break">On Break</span>`; if (s.startsWith('cover:')) return `<span class="chip cover">Covered by ${getName(s.split(':')[1])}</span>`; if (s==='dto') return `<span class="chip dto">DTO</span>`; return ''; }).join(''); const students = (opts.students||[]).map(id=>`<span class="student" draggable="${!STATE.locked}" data-student="${id}">${getName(id)||id}</span>`).join(''); return `<div class="tile"><div class="who">${badges}<div><div class="name">${nurse.name}</div>${rf}${students?`<div class="students">${students}</div>`:''}</div></div><div class="status">${statusChips}</div></div>`; }
function getStaffById(id){ return STATE.staff.find(s=>s.id===id); }
function getName(id){ const s = getStaffById(id); return s ? s.name : id; }

async function renderMain(){
  const active = await loadActive() || freshShift();
  renderSlot($(".slot[data-role='charge']"), active.charge, 'charge');
  renderSlot($(".slot[data-role='triage']"), active.triage, 'triage');
  const zc = $("#zoneContainer"); zc.innerHTML='';
  STATE.zones.forEach(z=>{
    const wrap = document.createElement('div');
    wrap.className = 'zone';
    wrap.innerHTML = `<div class="zone-title"><span>${z}</span><span class="mini-btns"><button class="btn" style="height:32px;padding:4px 8px" data-add="${z}">+ Add</button></span></div><div class="drop" data-zone="${z}"></div>`;
    zc.appendChild(wrap);
    const drop = wrap.querySelector('.drop');
    (active.zones[z]||[]).forEach(assign=>{
      const nurse = getStaffById(assign.nurseId);
      const tile = document.createElement('div');
      tile.className = 'slot';
      if (assign.dim) tile.classList.add('dim');
      tile.innerHTML = nurseTile(nurse, {status:assign.status||[], students:assign.students||[]});
      attachTileHandlers(tile, assign, 'main', z);
      tile.ondragover = e => { if (e.dataTransfer.getData('studentId')) e.preventDefault(); };
      tile.ondrop = async e => { const sid = e.dataTransfer.getData('studentId'); if (!sid || STATE.locked) return; await pushUndo(); const a = (active.zones[z]||[]).find(a=>a.nurseId===assign.nurseId); a.students = a.students||[]; a.students.push(sid); Object.values(active.zones).forEach(list => (list||[]).forEach(it => { if (it.students) it.students = it.students.filter(x=>x!==sid); })); await saveActive(active); renderAll(); };
      drop.appendChild(tile);
    });
    if (!STATE.locked) {
      drop.ondragover = e=> e.preventDefault();
      drop.ondrop = async e=>{ const id = e.dataTransfer.getData('nurseId'); if (!id) return; await pushUndo(); await moveNurseInMain(id, z); };
      wrap.querySelector('[data-add]').onclick = async ()=>{ const id = prompt("Add nurseId to "+z+" (must exist in Settings ▸ Nurses):"); if (!id) return; if (!getStaffById(id)) return alert("Unknown nurseId."); await pushUndo(); active.zones[z] = active.zones[z]||[]; Object.keys(active.zones).forEach(k=> active.zones[k] = (active.zones[k]||[]).filter(a=>a.nurseId!==id)); active.zones[z].push({nurseId:id, status:[], students:[]}); await saveActive(active); renderAll(); };
    }
  });
  $("#comments").value = active.comments || ''; $("#comments").oninput = debounce(async (e)=>{ active.comments = e.target.value; await saveActive(active); }, 300);
  $("#techs").value = (active.support?.techs||[]).join(', '); $("#vols").value  = (active.support?.vols||[]).join(', '); $("#sitters").value= (active.support?.sitters||[]).join(', ');
  ["techs","vols","sitters"].forEach(k=>{ $("#"+k).oninput = debounce(async ()=>{ active.support = active.support||{}; active.support.techs = $("#techs").value.split(',').map(s=>s.trim()).filter(Boolean); active.support.vols  = $("#vols").value.split(',').map(s=>s.trim()).filter(Boolean); active.support.sitters=$("#sitters").value.split(',').map(s=>s.trim()).filter(Boolean); await saveActive(active); }, 300); });
  const inc = $("#incomingList"); inc.innerHTML=''; (active.incoming||[]).forEach((ent, idx)=>{ const nurse = getStaffById(ent.nurseId); const arrived = !!ent.arrived; const shouldDim = !arrived && shouldDimIncoming(ent); const div = document.createElement('div'); div.className = 'mini'; div.innerHTML = `<div class="title ${shouldDim?'dim':''}">${nurse?.name||ent.nurseId}</div><div class="meta eta">${arrived ? 'Arrived' : 'ETA '+humanTime(ent.eta)}</div>`; div.onclick = async ()=>{ if (STATE.locked){ alert('Unlock to update.'); return; } await pushUndo(); active.incoming[idx].arrived = !arrived; await saveActive(active); renderAll(); }; inc.appendChild(div); });
  const off = $("#offgoingList"); off.innerHTML=''; (active.offgoing||[]).forEach(ent=>{ const nurse = getStaffById(ent.nurseId); const stillShow = isWithinGrace(ent.until); if (!stillShow) return; const div = document.createElement('div'); div.className = 'mini'; div.innerHTML = `<div class="title dim">${nurse?.name||ent.nurseId}</div><div class="meta">until ${humanTime(ent.until)} (+40m)</div>`; off.appendChild(div); });
  renderPhysicians(); await saveActive(active); updateUndoUI();
}
function attachTileHandlers(tile, assign, ctx, zoneName){ if (STATE.locked) return; tile.draggable = true; tile.ondragstart = e=> { e.dataTransfer.setData('nurseId', assign.nurseId); e.dataTransfer.effectAllowed = "move"; }; tile.querySelectorAll('.student').forEach(st => { st.ondragstart = ev => { ev.dataTransfer.setData('studentId', st.getAttribute('data-student')); ev.dataTransfer.effectAllowed = "move"; }; }); tile.onclick = async ()=>{ const choice = prompt("Edit: 1) Break toggle  2) Set Covering (nurseId)  3) Toggle DTO  4) Add Student (id)  5) Remove Students  6) Remove Assignment"); if (!choice) return; const active = await loadActive(); if (!active) return; const list = active.zones[zoneName]; const idx = list.findIndex(a=>a.nurseId===assign.nurseId); if (idx<0) return; const a = list[idx]; a.status = a.status||[]; a.students=a.students||[]; await pushUndo(); if (choice==='1'){ a.status = toggle(a.status,'break'); } else if (choice==='2'){ const id = prompt("Covering nurse id or blank to clear:"); a.status = a.status.filter(s=>!s.startsWith('cover:')); if (id) a.status.push('cover:'+id); } else if (choice==='3'){ a.status = toggle(a.status,'dto'); } else if (choice==='4'){ const sid= prompt("Student id/name:"); if (sid) a.students.push(sid); } else if (choice==='5'){ a.students = []; } else if (choice==='6'){ list.splice(idx,1); } await saveActive(active); renderAll(); }; }
function toggle(arr, val){ return arr.includes(val) ? arr.filter(x=>x!==val) : [...arr,val]; }
async function moveNurseInMain(nurseId, zone){ const active = await loadActive() || freshShift(); await pushUndo(); Object.keys(active.zones).forEach(z=>{ active.zones[z] = (active.zones[z]||[]).filter(a=>a.nurseId!==nurseId); }); active.zones[zone] = active.zones[zone]||[]; active.zones[zone].push({nurseId, status:[], students:[]}); await saveActive(active); renderAll(); }
function renderSlot(el, obj, which){ el.innerHTML = ''; const nurse = obj?.nurseId ? getStaffById(obj.nurseId) : null; const dim = obj?.dim ? 'dim' : ''; const div = document.createElement('div'); div.className = 'tile '+dim; div.innerHTML = nurseTile(nurse, {status:obj?.status||[], students:obj?.students||[]}); if (!STATE.locked){ div.onclick = async ()=>{ const id = prompt(`Set ${which.toUpperCase()} nurseId (exact Employee ID from Settings ▸ Nurses), or blank to clear:`, obj?.nurseId||''); const active = await loadActive() || freshShift(); await pushUndo(); if (obj?.nurseId && id && id!==obj.nurseId){ if (!confirm(`Replace current ${which} ${getName(obj.nurseId)} with ${getName(id) || id}?`)) return; } active[which] = id ? {nurseId:id, status:[], students:[]} : {}; await saveActive(active); renderAll(); }; el.ondragover = e=> e.preventDefault(); el.ondrop = async e=>{ const id = e.dataTransfer.getData('nurseId'); if (!id) return; await pushUndo(); const active = await loadActive() || freshShift(); if (obj?.nurseId && id!==obj.nurseId){ if (!confirm(`Replace current ${which} ${getName(obj.nurseId)} with ${getName(id) || id}?`)) return; } active[which] = {nurseId:id, status:[], students:[]}; await saveActive(active); renderAll(); }; } el.appendChild(div); }

/* Pending & roster */
function freshShift(){ return {date:STATE.date, shift:STATE.shift, charge:{}, triage:{}, zones:Object.fromEntries(STATE.zones.map(z=>[z,[]])), incoming:[], offgoing:[], support:{techs:[],vols:[],sitters:[]}, comments:''}; }
async function renderPending(){ const nextShift = STATE.shift==='day'?'night':'day'; const pending = await loadPending() || {date:STATE.date, shift:nextShift, charge:{}, triage:{}, zones:Object.fromEntries(STATE.zones.map(z=>[z,[]])), incoming:[]}; const roster = $("#pendingRoster"); roster.innerHTML=''; const q = ($("#rosterSearch").value||'').toLowerCase(); const sort = $("#rosterSort").value||'name'; const items = [...STATE.staff].filter(s=> !q || (s.name.toLowerCase().includes(q) || (s.id||'').toLowerCase().includes(q) || (s.rf||'').toLowerCase().includes(q)) ); const classOrder = {jewish:0, travel:1, float:2, other:3}; items.sort((a,b)=> sort==='id' ? String(a.id).localeCompare(String(b.id)) : sort==='class' ? (classOrder[(a.class||'other')] - classOrder[(b.class||'other')] || a.name.localeCompare(b.name)) : a.name.localeCompare(b.name)); items.forEach(s=>{ const it = document.createElement('div'); it.className='item'; it.draggable=true; it.textContent = `${s.name}  (${s.class||'other'} • RF ${s.rf||'—'} • ID ${s.id})`; it.dataset.nurseId = s.id; it.onclick = ()=> showHistory(s.id); it.ondragstart = e=> e.dataTransfer.setData('nurseId', s.id); roster.appendChild(it); }); renderPendingSlot($(".slot[data-pending='charge']"), pending, 'charge'); renderPendingSlot($(".slot[data-pending='triage']"), pending, 'triage'); const pz = $("#pendingZones"); pz.innerHTML=''; STATE.zones.forEach(z=>{ const wrap = document.createElement('div'); wrap.className='zone'; wrap.innerHTML = `<div class="zone-title"><span>${z}</span></div><div class="drop" data-pzone="${z}"></div>`; pz.appendChild(wrap); const drop = wrap.querySelector('.drop'); (pending.zones[z]||[]).forEach(a=>{ const nurse = getStaffById(a.nurseId); const slot = document.createElement('div'); slot.className='slot'; slot.innerHTML = nurseTile(nurse, {status:a.status||[], students:a.students||[]}); drop.appendChild(slot); }); drop.ondragover = e=> e.preventDefault(); drop.ondrop = e=>{ const id = e.dataTransfer.getData('nurseId'); if (!id) return; (async ()=>{ const p = await loadPending() || pending; Object.keys(p.zones).forEach(k=>{ p.zones[k] = (p.zones[k]||[]).filter(a=>a.nurseId!==id); }); p.zones[z] = p.zones[z]||[]; p.zones[z].push({nurseId:id, status:[], students:[]}); await savePending(p); renderPending(); })(); }; }); const pin = $("#pendingIncoming"); pin.innerHTML=''; (pending.incoming||[]).forEach((ent,i)=>{ const nurse = getStaffById(ent.nurseId); const row = document.createElement('div'); row.className='item'; row.textContent = `${nurse?.name||ent.nurseId}  • ETA ${humanTime(ent.eta)}`; row.onclick = async ()=>{ const eta = prompt("ETA (HH:MM, 24h)", ent.eta||'15:00'); if (!eta) return; const p = await loadPending() || pending; p.incoming[i].eta = eta; await savePending(p); renderPending(); }; pin.appendChild(row); }); $("#saveDraft").onclick = async ()=>{ await savePending(pending); toast("Draft saved"); }; $("#resetDraft").onclick = async ()=>{ const fresh = {date:STATE.date, shift:nextShift, charge:{}, triage:{}, zones:Object.fromEntries(STATE.zones.map(z=>[z,[]])), incoming:[]}; await savePending(fresh); renderPending(); }; $("#previewDraft").onclick = async ()=>{ alert("Preview shows how Main would look. (Review visually in Pending.)"); }; $("#startNext").onclick = async ()=>{ if (STATE.locked){ alert("Unlock first (PIN) to start next shift."); return; } if (!confirm("Start Next Shift now? This will archive current Main and activate Pending.")) return; const active = await loadActive() || freshShift(); await pushArchive({...active, archivedAt: new Date().toISOString()}); await logRolesFromObject(active); const p = await loadPending() || pending; p.comments = active.comments || ''; await saveActive({...p, activatedAt:new Date().toISOString()}); const nextKey = KS.PENDING(STATE.date, nextShift); await DB.del(nextKey); const until = addMinutesToHM(STATE.shift==='day'?STATE.anchors.day:STATE.anchors.night, 12*60 + 40); const og = collectOffgoing(active).map(nurseId=>({nurseId, until})); const newActive = await loadActive(); newActive.offgoing = og; await saveActive(newActive); toast("Next shift activated"); renderAll(); }; $("#rosterSearch").oninput = renderPending; $("#rosterSort").onchange = renderPending; }
function addMinutesToHM(hhmm, minutes){ let m = parseHM(hhmm) + minutes; m = ((m% (24*60)) + (24*60)) % (24*60); return `${pad2(Math.floor(m/60))}:${pad2(m%60)}`; }
function collectOffgoing(active){ const ids = new Set(); if (active.charge?.nurseId) ids.add(active.charge.nurseId); if (active.triage?.nurseId) ids.add(active.triage.nurseId); Object.values(active.zones||{}).forEach(list=> (list||[]).forEach(a=> ids.add(a.nurseId))); return Array.from(ids); }
function renderPendingSlot(el, pending, which){ el.innerHTML=''; const nurse = pending[which]?.nurseId ? getStaffById(pending[which].nurseId) : null; const d = document.createElement('div'); d.className='tile'; d.innerHTML = nurseTile(nurse); el.appendChild(d); el.ondragover = e=> e.preventDefault(); el.ondrop = async e=>{ const id = e.dataTransfer.getData('nurseId'); if (!id) return; const p = await loadPending() || pending; if (p[which]?.nurseId && id!==p[which].nurseId){ if (!confirm(`Replace current ${which} ${getName(p[which].nurseId)} with ${getName(id) || id}?`)) return; } p[which] = {nurseId:id, status:[], students:[]}; await savePending(p); renderPending(); }; }

/* Clock & anchors */
function tickClock(){ $("#clock").textContent = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }
async function checkAnchors(){ const min = minutesSinceMidnight(); const dayStart = parseHM(STATE.anchors.day||'07:00'); const nightStart= parseHM(STATE.anchors.night||'19:00'); const isTopOfMinute = (new Date().getSeconds()===0); if (!isTopOfMinute) return; if (min===dayStart || min===nightStart){ const pending = await loadPending(); if (pending) { if (confirm("Shift change time reached. Start Next Shift now?")) $("#startNext").click(); } else { if (confirm("Shift change time reached. Reset Main to blank for new shift?")) { await saveActive(freshShift()); renderAll(); } } } }
function shouldDimIncoming(ent){ const now = minutesSinceMidnight(); return now < parseHM(ent.eta); }
function isWithinGrace(until){ const now = minutesSinceMidnight(); return now <= parseHM(until); }

/* Physicians */
async function renderPhysicians(){ const key = KS.PHYS(STATE.date); const list = await DB.get(key) || []; const c = $("#physList"); c.innerHTML=''; if (!list.length){ c.innerHTML = `<div class="subtle">No entries yet for ${STATE.date}. Use Settings to fetch/paste iCal.</div>`; return; } list.forEach(p=>{ const div = document.createElement('div'); div.className='mini'; div.innerHTML = `<div class="title">${p.title}</div><div class="meta">${p.start} – ${p.end}</div>`; c.appendChild(div); }); }
async function tryFetchIcsForToday(){ if (!STATE.icsUrl) return; try{ const r = await fetch(STATE.icsUrl, {mode:'cors'}); if (!r.ok) throw new Error('HTTP '+r.status); const txt = await r.text(); const entries = parseICSForDate(txt, STATE.date); await DB.set(KS.PHYS(STATE.date), entries); renderPhysicians(); }catch(e){ console.warn('CORS or fetch error, use manual paste.', e); } }
function parseICSForDate(icsText, yyyy_mm_dd){ const lines = icsText.split(/\\r?\\n/); const events = []; let cur=null; for (const line of lines){ if (line.startsWith('BEGIN:VEVENT')) cur = {} else if (line.startsWith('END:VEVENT')){ if (cur?.start && cur?.end && cur?.title) events.push(cur); cur=null; } else if (line.startsWith('DTSTART')){ const dt = line.split(':')[1]?.trim(); cur.startRaw = dt; cur.start = icsToLocalHM(dt); cur.date = icsToLocalDate(dt); } else if (line.startsWith('DTEND')){ const dt = line.split(':')[1]?.trim(); cur.endRaw = dt; cur.end = icsToLocalHM(dt); } else if (line.startsWith('SUMMARY')){ cur.title = line.split(':').slice(1).join(':').trim(); } } return events.filter(e=> e.date === yyyy_mm_dd); }
function icsToLocalHM(dt){ const m = dt.match(/^(\\d{4})(\\d{2})(\\d{2})T(\\d{2})(\\d{2})/); if (!m) return '00:00'; const d = new Date(Date.UTC(+m[1],+m[2]-1,+m[3],+m[4],+m[5])); return pad2(d.getHours())+':'+pad2(d.getMinutes()); }
function icsToLocalDate(dt){ const m = dt.match(/^(\\d{4})(\\d{2})(\\d{2})T/); if (!m) return todayISO(); const d = new Date(Date.UTC(+m[1],+m[2]-1,+m[3],0,0)); return d.toISOString().slice(0,10); }

/* Settings */
function renderSettingsLists(){ const nl = $("#nurseList"); nl.innerHTML=''; STATE.staff.forEach(s=>{ const it = document.createElement('div'); it.className='item'; it.textContent = `${s.name} • ${s.class||'other'} • RF ${s.rf||'—'} • id: ${s.id}`; it.ondblclick = async ()=>{ const name = prompt("Name:", s.name); if (name===null) return; const rf = prompt("RF:", s.rf||''); if (rf===null) return; const cls = prompt("Class (jewish|travel|float|other):", s.class||'other'); if (cls===null) return; const newId = prompt("Employee ID (cannot be blank):", s.id); if (newId===null) return; if (!newId.trim()) return alert("ID cannot be blank."); if (newId !== s.id){ if (STATE.staff.some(x=> x!==s && x.id===newId)) return alert("Another nurse already has that ID."); await safeRenameId(s.id, newId); s.id = newId; } s.name=name||s.name; s.rf=rf||''; s.class=(cls||'other').toLowerCase(); await saveConfig(); renderSettingsLists(); renderAll(); }; nl.appendChild(it); }); const zl = $("#zoneList"); zl.innerHTML=''; STATE.zones.forEach((z,i)=>{ const it = document.createElement('div'); it.className='item'; it.textContent = z; it.onclick = ()=>{ const nz = prompt("Rename zone (blank to delete):", z); if (nz===null) return; if (nz===''){ STATE.zones.splice(i,1); } else { STATE.zones[i]=nz; } saveConfig(); renderSettingsLists(); renderAll(); }; zl.appendChild(it); }); const jig = document.getElementById('jigglerToggle'); if (jig) jig.checked = !!STATE.jiggler; }
function bindSettings(){
  const doAdd = async ()=>{ const id = $("#nId").value.trim(); const name = $("#nName").value.trim(); const rf = $("#nRF").value.trim(); const cls = $("#nClass").value; if (!id){ alert("Enter Employee ID"); return; } if (!name){ alert("Enter name"); return; } if (STATE.staff.some(s=>s.id===id)) { alert("Employee ID already exists."); return; } STATE.staff.push({id,name,rf,class:cls}); $("#nId").value=''; $("#nName").value=''; $("#nRF").value=''; await saveConfig(); renderSettingsLists(); renderAll(); toast("Nurse added"); };
  $("#addNurse").addEventListener('click', doAdd); ["nId","nName","nRF"].forEach(id=> $("#"+id).addEventListener('keydown', e=>{ if (e.key==='Enter') doAdd(); }));
  $("#addZone").addEventListener('click', ()=>{ const n = $("#zName").value.trim(); if (!n) return; STATE.zones.push(n); $("#zName").value=''; saveConfig(); renderSettingsLists(); renderAll(); });
  $("#saveAnchors").addEventListener('click', ()=>{ STATE.anchors.day = $("#dayAnchor").value||'07:00'; STATE.anchors.night= $("#nightAnchor").value||'19:00'; saveConfig(); toast("Anchors saved"); });
  $("#savePin").addEventListener('click', async ()=>{ const pin = $("#pinInput").value.trim(); if (!/^\\d{4,6}$/.test(pin)) return alert("PIN must be 4–6 digits."); STATE.pin = pin; $("#pinInput").value=''; saveConfig(); toast("PIN saved"); });
  $("#saveRelock").addEventListener('click', ()=>{ const v = parseInt($("#relockMin").value,10); STATE.relockMin = (!isNaN(v) && v>0) ? v : 3; saveConfig(); toast("Auto-relock updated"); });
  $("#saveIcsUrl").addEventListener('click', ()=>{ const url = $("#icsUrl").value.trim(); if (!url) return alert("Enter an iCal URL"); STATE.icsUrl = url; saveConfig(); toast("iCal URL saved"); });
  $("#fetchIcsNow").addEventListener('click', tryFetchIcsForToday);
  $("#parseIcs").addEventListener('click', async ()=>{ const txt = $("#icsText").value.trim(); if (!txt){ alert("Paste ICS text first."); return; } const entries = parseICSForDate(txt, STATE.date); await DB.set(KS.PHYS(STATE.date), entries); toast(`Parsed ${entries.length} physician entries`); renderPhysicians(); });
  $("#exportAll").addEventListener('click', async ()=>{ const keys = await DB.keys(); const all = {}; for (const k of keys){ all[k] = await DB.get(k); } const blob = new Blob([JSON.stringify(all,null,2)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `edb-export-${STATE.date}.json`; a.click(); URL.revokeObjectURL(a.href); });
  $("#exportCSV").addEventListener('click', async ()=>{ const arch = await DB.get(KS.ARCHIVE) || []; const rows = [['date','shift','role','nurseId','dto']]; arch.forEach(sh => { if (sh.charge?.nurseId) rows.push([sh.date, sh.shift, 'Charge', sh.charge.nurseId, '']); if (sh.triage?.nurseId) rows.push([sh.date, sh.shift, 'Triage', sh.triage.nurseId, '']); Object.entries(sh.zones||{}).forEach(([z,list])=> (list||[]).forEach(a=> rows.push([sh.date, sh.shift, z, a.nurseId, (a.status||[]).includes('dto')?'true':'']))); }); const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\\n'); const blob = new Blob([csv], {type:'text/csv'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `edb-archives-${STATE.date}.csv`; a.click(); URL.revokeObjectURL(a.href); });

  // SMART IMPORT (replace if full DB; else merge staff if staff array found)
  $("#importFile").addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    const txt = await f.text(); let data;
    try{ data = JSON.parse(txt); }catch{ alert("Invalid JSON"); e.target.value=''; return; }
    if (isFullDbExport(data)){
      // Full DB snapshot
      const keys = await DB.keys(); for (const k of keys){ await DB.del(k); }
      for (const [k,v] of Object.entries(data)){ await DB.set(k,v); }
      logImport(`Imported full DB snapshot: ${Object.keys(data).length} keys.`);
      alert("Imported full database. Reloading…"); location.reload();
      return;
    }
    // Try to merge staff
    const incoming = extractStaffArray(data);
    if (incoming.length){
      const res = await mergeStaff(incoming);
      logImport(`Smart import staff → added ${res.added}, updated ${res.updated}.`);
      toast(`Added ${res.added}, updated ${res.updated}`);
      renderSettingsLists(); renderAll();
    } else {
      logImport("Smart import found neither a full DB nor a staff array.");
      alert("Did not find a valid staff array or database keys in that JSON.");
    }
    e.target.value='';
  });

  // STAFF MERGE (always merge staff)
  $("#importStaffFile").addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    const txt = await f.text(); let data;
    try{ data = JSON.parse(txt); }catch{ alert("Invalid JSON"); e.target.value=''; return; }
    const incoming = extractStaffArray(data);
    if (!incoming.length){ alert("No staff found in file. Expected an array under data.staff or top-level."); e.target.value=''; return; }
    const res = await mergeStaff(incoming);
    logImport(`Merge staff → added ${res.added}, updated ${res.updated}.`);
    toast(`Added ${res.added}, updated ${res.updated}`);
    renderSettingsLists(); renderAll();
    e.target.value='';
  });

  $("#clearAll").addEventListener('click', async ()=>{
    if (!confirm("Clear ALL local data?")) return;
    const keys = await DB.keys(); for (const k of keys){ await DB.del(k); }
    alert("Cleared. Reloading…"); location.reload();
  });

  const jig = document.getElementById('jigglerToggle');
  if (jig) jig.addEventListener('change', async ()=>{ STATE.jiggler = jig.checked; await saveConfig(); updateJiggler(); toast(STATE.jiggler ? "Keep-awake ON" : "Keep-awake OFF"); });
}

/* Import helpers */
function isFullDbExport(data){
  if (!data || typeof data!=='object' || Array.isArray(data)) return false;
  const keys = Object.keys(data);
  // treat as full export if it has at least one of our known keys AND values look plausible
  return keys.some(k => [KS.CONFIG, KS.STAFF, KS.ARCHIVE, KS.HISTORY].includes(k));
}
function extractStaffArray(data){
  if (Array.isArray(data)) return data;
  if (Array.isArray(data?.staff)) return data.staff;
  if (Array.isArray(data?.data?.staff)) return data.data.staff;
  // Also consider DB snapshot that includes a STAFF key but nothing else
  if (Array.isArray(data?.[KS.STAFF])) return data[KS.STAFF];
  return [];
}
function normalizeStaff(x){
  if (!x || typeof x!=='object') return {id:'', name:''};
  const id = String(x.id ?? x.empId ?? x.employeeId ?? '').trim();
  const name = String(x.name ?? x.fullName ?? `${x.firstName||''} ${x.lastName||''}`.trim()).trim();
  const rf = (x.rf ?? x.extension ?? '').toString();
  let cls = (x.class ?? x.cls ?? x.classification ?? x.type ?? x.category ?? 'other').toString().toLowerCase();
  if (!['jewish','travel','float','other'].includes(cls)) cls = 'other';
  return {id, name, rf, class: cls};
}
async function mergeStaff(arr){
  let added=0, updated=0;
  for (const raw of arr){
    const item = normalizeStaff(raw);
    if (!item.id || !item.name) continue;
    const existing = STATE.staff.find(s=>s.id===item.id);
    if (existing){
      // update non-empty fields
      if (item.name && item.name!==existing.name) { existing.name = item.name; updated++; }
      if (item.rf!=null && item.rf!==existing.rf) { existing.rf = item.rf; updated++; }
      if (item.class && item.class!==existing.class){ existing.class = item.class; updated++; }
    } else {
      STATE.staff.push(item); added++;
    }
  }
  await saveConfig();
  return {added, updated};
}

/* History etc. */
async function showHistory(nurseId){ const h = await getHistory(); const list = h[nurseId]||[]; $("#historyPane").innerHTML = list.length ? (`<h4 style="margin:0 0 8px 0">${getName(nurseId)}</h4>`+ list.map(it=>`<div class="kicker">${it.date} ${it.shift} — ${it.role}${it.dto?' (DTO)':''}</div>`).join('')) : `<div class="subtle">No history.</div>`; }
async function logRolesFromObject(obj){ const roles = []; if (obj.charge?.nurseId) roles.push({id:obj.charge.nurseId, role:'Charge'}); if (obj.triage?.nurseId) roles.push({id:obj.triage.nurseId, role:'Triage'}); Object.entries(obj.zones||{}).forEach(([z,list])=>{ (list||[]).forEach(a=> roles.push({id:a.nurseId, role:z, dto:(a.status||[]).includes('dto')})); }); const h = await getHistory(); roles.forEach(r=>{ h[r.id] = h[r.id]||[]; h[r.id].unshift({date:obj.date, shift:obj.shift, role:r.role, dto:!!r.dto}); h[r.id] = h[r.id].slice(0,5); }); await setHistory(h); }
document.addEventListener('DOMContentLoaded', ()=> { document.getElementById('printBtn')?.addEventListener('click', async ()=> { const active = await loadActive(); if (active) await logRolesFromObject(active); }); });

/* History Tab */
function bindHistory(){ $("#histApply").addEventListener('click', renderHistory); $("#histClear").addEventListener('click', ()=>{ $("#histFilterName").value=''; $("#histFrom").value=''; $("#histTo").value=''; renderHistory(); }); }
async function renderHistory(){ const arch = await DB.get(KS.ARCHIVE) || []; const filter = ($("#histFilterName").value||'').toLowerCase(); const from = $("#histFrom").value; const to   = $("#histTo").value; const rows = []; arch.forEach(sh => { const dateOk = (!from || sh.date>=from) && (!to || sh.date<=to); if (!dateOk) return; if (sh.charge?.nurseId) rows.push([sh.date, sh.shift, 'Charge', getName(sh.charge.nurseId), '']); if (sh.triage?.nurseId) rows.push([sh.date, sh.shift, 'Triage', getName(sh.triage.nurseId), '']); Object.entries(sh.zones||{}).forEach(([z,list])=> (list||[]).forEach(a=> rows.push([sh.date, sh.shift, z, getName(a.nurseId), (a.status||[]).includes('dto')?'DTO':'']))); }); const tb = $("#histTable tbody"); tb.innerHTML=''; rows .filter(r => !filter || r[3].toLowerCase().includes(filter) || r[2].toLowerCase().includes(filter)) .sort((a,b)=> (a[0]+a[1]+a[2]).localeCompare(b[0]+b[1]+b[2])) .forEach(r=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td>${r[0]}</td><td><span class="pill2">${r[1]}</span></td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td>`; tb.appendChild(tr); }); }

/* Keep-awake */
async function requestWakeLock(){ try{ if ('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', ()=> console.log('Wake Lock released')); document.addEventListener('visibilitychange', async ()=>{ if (document.visibilityState === 'visible' && STATE.jiggler){ try{ wakeLock = await navigator.wakeLock.request('screen'); }catch(e){ console.warn('Wake Lock re-request failed', e); } }); } } }catch(e){ console.warn('Wake Lock request failed:', e); } }
function startJiggleFallback(){ stopJiggleFallback(); jigTimer = setInterval(()=>{ const y = window.scrollY; window.scrollTo(0, y+1); setTimeout(()=> window.scrollTo(0, y), 250); const evt = new MouseEvent('mousemove', {bubbles:true, cancelable:true, clientX:1, clientY:1}); document.body.dispatchEvent(evt); }, 30000); }
function stopJiggleFallback(){ if (jigTimer) { clearInterval(jigTimer); jigTimer = null; } }
async function updateJiggler(){ const jig = document.getElementById('jigglerToggle'); if (jig) jig.checked = !!STATE.jiggler; if (STATE.jiggler){ await requestWakeLock(); startJiggleFallback(); } else { if (wakeLock && wakeLock.release){ try{ await wakeLock.release(); }catch(e){} wakeLock = null; } stopJiggleFallback(); } }

/* Safe rename across local data */
async function safeRenameId(oldId, newId){ if (oldId===newId) return; STATE.staff = STATE.staff.map(s=> s.id===oldId ? {...s, id:newId} : s); await saveConfig(); const keys = await DB.keys(); for (const k of keys){ const val = await DB.get(k); if (k===KS.HISTORY){ const h = val || {}; if (h[oldId]){ h[newId] = (h[newId]||[]).concat(h[oldId]); delete h[oldId]; await DB.set(KS.HISTORY, h); } continue; } if (k.startsWith('phys:')) continue; const updated = deepReplaceId(val, oldId, newId); await DB.set(k, updated); } toast(`Renamed ID ${oldId} → ${newId}`); }
function deepReplaceId(node, oldId, newId){ if (Array.isArray(node)){ return node.map(n=> deepReplaceId(n, oldId, newId)); } else if (node && typeof node==='object'){ const out = {}; for (const [kk,vv] of Object.entries(node)){ if (kk==='nurseId' && vv===oldId){ out[kk]=newId; } else if (kk==='status' && Array.isArray(vv)){ out[kk]= vv.map(s => (typeof s==='string' && s.startsWith('cover:') && s.slice(6)===oldId) ? ('cover:'+newId) : s); } else { out[kk]= deepReplaceId(vv, oldId, newId); } } return out; } return node; }

/* Misc */
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
</script>
</body>
</html>
